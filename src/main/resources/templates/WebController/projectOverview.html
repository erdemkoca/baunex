<div class="card mb-4">
  <div class="card-header">
    {#if project.id}
      Projekt bearbeiten: {project.name}
    {#else}
      Neues Projekt erstellen
    {/if}
  </div>
  <div class="card-body">

    <form action="/projects/save" method="post">
      {#if project.id}
        <input type="hidden" name="id" value="{project.id}" />
      {/if}

      <!-- Projektname -->
      <div class="mb-3">
        <label for="name" class="form-label">Projektname</label>
        <input
          type="text"
          id="name"
          name="name"
          class="form-control"
          value="{project.name ?: ''}"
          required
        />
      </div>

      <!-- Kunde -->
      <div class="mb-3">
        <label for="customerId" class="form-label">Kunde</label>
        <select
          id="customerId"
          name="customerId"
          class="form-select"
          required
        >
          <option value="" disabled {#if project.customerId == null}selected{/if}>
            -- Kunde auswählen --
          </option>
          {#for cust in customers}
            <option
              value="{cust.id}"
              {#if cust.id == project.customerId}selected{/if}
            >
              {#if cust.companyName}
                {cust.companyName}
              {#else}
                {cust.firstName} {cust.lastName}
              {/if}
            </option>
          {/for}
        </select>
      </div>

      <!-- Budget -->
      <div class="mb-3">
        <label for="budget" class="form-label">Budget (CHF)</label>
        <div class="input-group">
          <span class="input-group-text">CHF</span>
          <input
            type="number"
            id="budget"
            name="budget"
            class="form-control"
            value="{project.budget}"
            min="0"
            required
          />
        </div>
      </div>

      <!-- Ansprechpartner -->
      <div class="mb-3">
        <label for="contact" class="form-label">Ansprechpartner</label>
        <input
          type="text"
          id="contact"
          name="contact"
          class="form-control"
          placeholder="Name oder E-Mail"
          value="{project.contact ?: ''}"
        />
      </div>

      <!-- Status -->
      <div class="mb-3">
        <label for="status" class="form-label">Status</label>
        <select id="status" name="status" class="form-select">
          <option value="PLANNED"     {#if project.status.name == 'PLANNED'}selected{/if}>Geplant</option>
          <option value="IN_PROGRESS" {#if project.status.name == 'IN_PROGRESS'}selected{/if}>In Bearbeitung</option>
          <option value="COMPLETED"   {#if project.status.name == 'COMPLETED'}selected{/if}>Abgeschlossen</option>
          <option value="CANCELLED"   {#if project.status.name == 'CANCELLED'}selected{/if}>Abgebrochen</option>
        </select>
      </div>

      <!-- Beschreibung -->
      <div class="mb-3">
        <label for="description" class="form-label">Beschreibung</label>
        <textarea
          id="description"
          name="description"
          class="form-control"
          rows="3"
        >{project.description ?: ''}</textarea>
      </div>

      <!-- Start-/Enddatum -->
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label for="startDate" class="form-label">Startdatum</label>
          <input
            type="date"
            id="startDate"
            name="startDate"
            class="form-control"
            value="{project.startDate ?: ''}"
          />
        </div>
        <div class="col-md-6">
          <label for="endDate" class="form-label">Enddatum</label>
          <input
            type="date"
            id="endDate"
            name="endDate"
            class="form-control"
            value="{project.endDate ?: ''}"
          />
        </div>
      </div>

      <!-- Adresse -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <label for="street" class="form-label">Strasse</label>
          <input
            type="text"
            id="street"
            name="street"
            class="form-control"
            value="{project.street ?: ''}"
          />
        </div>
        <div class="col-md-6">
          <label for="city" class="form-label">Stadt</label>
          <input
            type="text"
            id="city"
            name="city"
            class="form-control"
            value="{project.city ?: ''}"
          />
        </div>
      </div>

      <!-- Projekt-Notizen (initial) -->
      <fieldset class="border rounded p-3 mb-3">
        <legend class="float-none w-auto px-2">Notizen</legend>

        <div id="projectNotesContainer">
          {#if project.notes != null && !project.notes.isEmpty()}
            {#for note in project.notes}
              <div class="note-block mb-3 border rounded p-2">
                <input type="hidden" name="initialNotes[][id]" value="{note.id}" />
                <!-- Titel, Kategorie, Inhalt wie gehabt … -->

                <div>
                  <label class="form-label">Tags (Komma-getrennt)</label>
                  <input
                          type="text"
                          class="form-control"
                          name="initialNotes[][tags]"
                          value="{#if note.tags != null && !note.tags.isEmpty()}{#for tag in note.tags}{tag}{#if tag != note.tags.get(note.tags.size() - 1)}, {/if}{/for}{/if}"
                          placeholder="z. B. wichtig, dringlich"
                  />
                </div>

                <button
                        type="button"
                        class="btn btn-danger btn-sm mt-2"
                        onclick="removeProjectNoteBlock(this)"
                >
                  Entfernen
                </button>
              </div>
            {/for}
          {/if}
        </div>

        <button
                type="button"
                class="btn btn-outline-primary btn-sm"
                onclick="addProjectNoteBlock()"
        >
          <i class="bi bi-plus-circle me-1"></i>Notiz hinzufügen
        </button>
      </fieldset>

      <!-- … Rest des Formulars und JavaScript … -->


      <!-- Speichern / Abbrechen -->
      <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-save me-1"></i>
          {#if project.id}Projekt aktualisieren{#else}Projekt erstellen{/if}
        </button>
        <a href="/projects" class="btn btn-outline-secondary">Abbrechen</a>
      </div>
    </form>
  </div>
</div>

<!-- JavaScript zum dynamischen Hinzufügen/Entfernen der Notizen-Blöcke -->
<script>
  function addProjectNoteBlock() {
    const container = document.getElementById('projectNotesContainer');
    const block = document.createElement('div');
    block.className = 'note-block mb-3 border rounded p-2';
    block.innerHTML = `
      <input type="hidden" name="initialNotes[][id]" value="" />
      <div class="mb-2">
        <label class="form-label">Titel</label>
        <input
          type="text"
          class="form-control"
          name="initialNotes[][title]"
          placeholder="Optional"
        />
      </div>
      <div class="mb-2">
        <label class="form-label">Kategorie</label>
        <select
          class="form-select"
          name="initialNotes[][category]"
          required
        >
          <option value="">-- wählen --</option>
          {#for cat in categories}
            <option value="{cat.name}">{cat.name}</option>
          {/for}
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label">Inhalt</label>
        <textarea
          class="form-control"
          name="initialNotes[][content]"
          rows="2"
          required
        ></textarea>
      </div>
      <div>
        <label class="form-label">Tags (Komma-getrennt)</label>
        <input
          type="text"
          class="form-control"
          name="initialNotes[][tags]"
          placeholder="z. B. wichtig, dringlich"
        />
      </div>
      <button
        type="button"
        class="btn btn-danger btn-sm mt-2"
        onclick="removeProjectNoteBlock(this)"
      >
        Entfernen
      </button>
    `;
    container.appendChild(block);
  }

  function removeProjectNoteBlock(btn) {
    btn.closest('.note-block').remove();
  }
</script>
