{#include layout}
{#title}{#if entry}Zeiterfassung bearbeiten{#else}Neue Zeiterfassung{/if} – Baunex{/title}
{#header}{#if entry}Zeiterfassung bearbeiten{#else}Neue Zeiterfassung{/if}{/header}
{#content}
<div class="card">
    <div class="card-header">{#if entry}Eintrag bearbeiten{#else}Neuer Eintrag{/if}</div>
    <div class="card-body">
        <form action="/timetracking/save" method="post">
            {#if entry}
            <input type="hidden" name="id" value="{entry.id}" />
            {/if}

            <!-- Versteckte Standardwerte -->
            <input type="hidden" name="hasNightSurcharge" value="false">
            <input type="hidden" name="hasWeekendSurcharge" value="false">
            <input type="hidden" name="hasHolidaySurcharge" value="false">
            <input type="hidden" name="notBillable" value="false">
            <input type="hidden" name="invoiced" value="false">
            <input type="hidden" name="hasWaitingTime" value="false">

            <!-- Neuer Feld: Titel (optional) -->
            <div class="mb-3">
                <label for="title" class="form-label">Titel (optional)</label>
                <input type="text"
                       id="title"
                       name="title"
                       class="form-control"
                       placeholder="Kurze Beschreibung"
                       value="{entry.title ?: ''}" />
            </div>

            <!-- Mitarbeiter -->
            <div class="mb-3">
                <label for="employeeId" class="form-label">Mitarbeiter</label>
                <select class="form-select" id="employeeId" name="employeeId" required>
                    {#for employee in employees}
                    <option value="{employee.id}"
                            {#if entry != null && entry.employeeId == employee.id}selected{/if}>
                        {employee.email}
                    </option>
                    {/for}
                </select>
            </div>

            <!-- Projekt -->
            <div class="mb-3">
                <label for="projectId" class="form-label">Projekt</label>
                <select class="form-select" id="projectId" name="projectId" required>
                    {#for project in projects}
                    <option value="{project.id}"
                            {#if entry != null && entry.projectId == project.id}selected{/if}>
                        {project.name}
                    </option>
                    {/for}
                </select>
            </div>

            <!-- Datum -->
            <div class="mb-3">
                <label for="date" class="form-label">Datum</label>
                <input type="date" class="form-control" id="date" name="date"
                       value="{#if entry}{entry.date}{#else}{currentDate}{/if}" required />
            </div>

            <!-- Gearbeitete Stunden -->
            <div class="mb-3">
                <label for="hoursWorked" class="form-label">Gearbeitete Stunden</label>
                <input type="number" class="form-control" id="hoursWorked" name="hoursWorked"
                       step="0.1" min="0"
                       value="{#if entry}{entry.hoursWorked}{/if}"
                       required />
            </div>

            <!-- Notizen‐Bereich -->
            <fieldset class="border rounded p-3 mb-3">
                <legend class="float-none w-auto px-2">Notizen</legend>

                <div id="notesContainer">
                    {#if entry != null && !entry.notes.isEmpty()}
                    {#for note in entry.notes}
                    <div class="note-block mb-3 border rounded p-2">
                        <input type="hidden" name="notes[][id]" value="{note.id}" />

                        <div class="mb-2">
                            <label class="form-label">Titel</label>
                            <input type="text" class="form-control" name="notes[][title]"
                                   value="{note.title ?: ''}" placeholder="Optional" />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Kategorie</label>
                            <select class="form-select" name="notes[][category]" required>
                                <option value="" disabled {#if note.category == null}selected{/if}>
                                    -- auswählen --
                                </option>
                                {#for cat in categories}
                                <option value="{cat.name}"
                                        {#if note.category.name == cat.name}selected{/if}>
                                    {cat.name}
                                </option>
                                {/for}
                            </select>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Inhalt</label>
                            <textarea class="form-control" name="notes[][content]" rows="2" required>{note.content}</textarea>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Tags (Komma‐getrennt)</label>
                            <input
                                    type="text"
                                    class="form-control"
                                    name="notes[][tags]"
                                    value="{#if !note.tags.isEmpty()}{#for tag in note.tags}{tag}{#if tag != note.tags.get(note.tags.size() - 1)}, {/if}{/for}{/if}"
                                    placeholder="z. B. dringlich,prüfung" />
                        </div>

                        <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeNoteBlock(this)">
                            Entfernen
                        </button>
                    </div>
                    {/for}
                    {/if}
                </div>

                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addNoteBlock()">
                    <i class="bi bi-plus-circle me-1"></i>Notiz hinzufügen
                </button>
            </fieldset>

            <!-- Stundensatz -->
            <div class="mb-3">
                <label for="hourlyRate" class="form-label">Stundensatz (CHF)</label>
                <input type="number" class="form-control" id="hourlyRate" name="hourlyRate"
                       step="0.01"
                       value="{#if entry}{entry.hourlyRate}{/if}" />
            </div>

            <!-- Zuschläge -->
            <div class="mb-3">
                <label class="form-label">Zuschläge</label>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="hasNightSurcharge"
                           name="hasNightSurcharge" value="true"
                           {#if entry && entry.hasNightSurcharge}checked{/if}
                           onchange="updateHiddenInput(this)">
                    <label class="form-check-label" for="hasNightSurcharge">Nachtzuschlag</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="hasWeekendSurcharge"
                           name="hasWeekendSurcharge" value="true"
                           {#if entry && entry.hasWeekendSurcharge}checked{/if}
                           onchange="updateHiddenInput(this)">
                    <label class="form-check-label" for="has
