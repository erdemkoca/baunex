{#include layout}
  {#title}{#if entry}Zeiterfassung bearbeiten{#else}Neue Zeiterfassung{/if} – Baunex{/title}
  {#header}{#if entry}Zeiterfassung bearbeiten{#else}Neue Zeiterfassung{/if}{/header}
  {#content}
    <div class="card">
      <div class="card-header">{#if entry}Eintrag bearbeiten{#else}Neuer Eintrag{/if}</div>
      <div class="card-body">
        <form action="/timetracking/save" method="post">
          {#if entry}
            <input type="hidden" name="id" value="{entry.id}" />
          {/if}

          <!-- Versteckte Standardwerte -->
          <input type="hidden" name="hasNightSurcharge" value="false">
          <input type="hidden" name="hasWeekendSurcharge" value="false">
          <input type="hidden" name="hasHolidaySurcharge" value="false">
          <input type="hidden" name="notBillable" value="false">
          <input type="hidden" name="invoiced" value="false">
          <input type="hidden" name="hasWaitingTime" value="false">

          <!-- Mitarbeiter -->
          <div class="mb-3">
            <label for="employeeId" class="form-label">Mitarbeiter</label>
            <select class="form-select" id="employeeId" name="employeeId" required>
              {#for employee in employees}
                <option value="{employee.id}"
                        {#if entry != null && entry.employeeId == employee.id}selected{/if}>
                  {employee.email}
                </option>
              {/for}
            </select>
          </div>

          <!-- Projekt -->
          <div class="mb-3">
            <label for="projectId" class="form-label">Projekt</label>
            <select class="form-select" id="projectId" name="projectId" required>
              {#for project in projects}
                <option value="{project.id}"
                        {#if entry != null && entry.projectId == project.id}selected{/if}>
                  {project.name}
                </option>
              {/for}
            </select>
          </div>

          <!-- Datum -->
          <div class="mb-3">
            <label for="date" class="form-label">Datum</label>
            <input type="date" class="form-control" id="date" name="date"
                   value="{#if entry}{entry.date}{#else}{currentDate}{/if}" required />
          </div>

          <!-- Gearbeitete Stunden -->
          <div class="mb-3">
            <label for="hoursWorked" class="form-label">Gearbeitete Stunden</label>
            <input type="number" class="form-control" id="hoursWorked" name="hoursWorked"
                   step="0.1" min="0"
                   value="{#if entry}{entry.hoursWorked}{/if}"
                   required />
          </div>

          <!-- Notizen‐Bereich -->
          <fieldset class="border rounded p-3 mb-3">
            <legend class="float-none w-auto px-2">Notizen</legend>

            <div id="notesContainer">
              {#if entry != null && !entry.notes.isEmpty()}
                {#for note in entry.notes}
                  <div class="note-block mb-3 border rounded p-2">
                    <input type="hidden" name="notes[][id]" value="{note.id}" />

                    <div class="mb-2">
                      <label class="form-label">Titel</label>
                      <input type="text" class="form-control" name="notes[][title]"
                             value="{note.title ?: ''}" placeholder="Optional" />
                    </div>

                    <div class="mb-2">
                      <label class="form-label">Kategorie</label>
                      <select class="form-select" name="notes[][category]" required>
                        <option value="" disabled {#if note.category == null}selected{/if}>
                          -- auswählen --
                        </option>
                        {#for cat in categories}
                          <option value="{cat.name}"
                                  {#if note.category.name == cat.name}selected{/if}>
                            {cat.name}
                          </option>
                        {/for}
                      </select>
                    </div>

                    <div class="mb-2">
                      <label class="form-label">Inhalt</label>
                      <textarea class="form-control" name="notes[][content]" rows="2" required>{note.content}</textarea>
                    </div>

                    <div class="mb-2">
                      <label class="form-label">Tags (Komma‐getrennt)</label>
                      <input
                        type="text"
                        class="form-control"
                        name="notes[][tags]"
                        value="{#if !note.tags.isEmpty()}{#for tag in note.tags}{tag}{#if tag != note.tags.get(note.tags.size() - 1)}, {/if}{/for}{/if}"
                        placeholder="z. B. dringlich,prüfung" />
                    </div>

                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeNoteBlock(this)">
                      Entfernen
                    </button>
                  </div>
                {/for}
              {/if}
            </div>

            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addNoteBlock()">
              <i class="bi bi-plus-circle me-1"></i>Notiz hinzufügen
            </button>
          </fieldset>

          <!-- Stundensatz -->
          <div class="mb-3">
            <label for="hourlyRate" class="form-label">Stundensatz (CHF)</label>
            <input type="number" class="form-control" id="hourlyRate" name="hourlyRate"
                   step="0.01"
                   value="{#if entry}{entry.hourlyRate}{/if}" />
          </div>

          <!-- Zuschläge -->
          <div class="mb-3">
            <label class="form-label">Zuschläge</label>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="hasNightSurcharge"
                     name="hasNightSurcharge" value="true"
                     {#if entry && entry.hasNightSurcharge}checked{/if}
                     onchange="updateHiddenInput(this)">
              <label class="form-check-label" for="hasNightSurcharge">Nachtzuschlag</label>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="hasWeekendSurcharge"
                     name="hasWeekendSurcharge" value="true"
                     {#if entry && entry.hasWeekendSurcharge}checked{/if}
                     onchange="updateHiddenInput(this)">
              <label class="form-check-label" for="hasWeekendSurcharge">Wochenendzuschlag</label>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="hasHolidaySurcharge"
                     name="hasHolidaySurcharge" value="true"
                     {#if entry && entry.hasHolidaySurcharge}checked{/if}
                     onchange="updateHiddenInput(this)">
              <label class="form-check-label" for="hasHolidaySurcharge">Feiertagszuschlag</label>
            </div>
          </div>

          <!-- Zusätzliche Kosten -->
          <div class="mb-3">
            <label class="form-label">Zusätzliche Kosten</label>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="travelTimeMinutes" class="form-label">Reisezeit (Minuten)</label>
                <input type="number" class="form-control" id="travelTimeMinutes"
                       name="travelTimeMinutes" min="0"
                       value="{#if entry}{entry.travelTimeMinutes}{/if}" />
              </div>
              <div class="col-md-6">
                <label for="disposalCost" class="form-label">Entsorgungskosten (CHF)</label>
                <input type="number" class="form-control" id="disposalCost"
                       name="disposalCost" step="0.01" min="0"
                       value="{#if entry}{entry.disposalCost}{/if}" />
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="hasWaitingTime"
                         name="hasWaitingTime" value="true"
                         {#if entry && entry.hasWaitingTime}checked{/if}
                         onchange="updateHiddenInput(this)">
                  <label class="form-check-label" for="hasWaitingTime">Wartezeit</label>
                </div>
              </div>
              <div class="col-md-6">
                <label for="waitingTimeMinutes" class="form-label">Wartezeit (Minuten)</label>
                <input type="number" class="form-control" id="waitingTimeMinutes"
                       name="waitingTimeMinutes" min="0"
                       value="{#if entry}{entry.waitingTimeMinutes}{/if}" />
              </div>
            </div>
          </div>

          <!-- Nicht verrechenbar & Fakturiert -->
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="notBillable"
                   name="notBillable" value="true"
                   {#if entry && !entry.billable}checked{/if}
                   onchange="updateHiddenInput(this)">
            <label class="form-check-label" for="notBillable">Nicht verrechenbar</label>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="invoiced"
                   name="invoiced" value="true"
                   {#if entry && entry.invoiced}checked{/if}
                   onchange="updateHiddenInput(this)">
            <label class="form-check-label" for="invoiced">Fakturiert</label>
          </div>

          <!-- Katalogartikel (unverändert) -->
          <div class="mb-3">
            <label class="form-label">Katalogartikel</label>
            <div class="catalog-items-container">
              <table class="table" id="catalogItemsTable">
                <thead>
                <tr>
                  <th>Artikelname</th>
                  <th>Menge</th>
                  <th>Einzelpreis</th>
                  <th>Gesamt</th>
                  <th>Aktionen</th>
                </tr>
                </thead>
                <tbody>
                {#if entry != null && !entry.catalogItems.isEmpty()}
                  {#for item in entry.catalogItems}
                    <tr>
                      <td>{item.itemName}</td>
                      <td>{item.quantity}</td>
                      <td>{item.unitPrice} CHF</td>
                      <td>{item.totalPrice} CHF</td>
                      <td>
                        <button type="button" class="btn btn-danger btn-sm"
                                onclick="removeCatalogItem(this)">Entfernen</button>
                        <input type="hidden" name="catalogItemIds" value="{item.catalogItemId}">
                        <input type="hidden" name="catalogItemQuantities" value="{item.quantity}">
                        <input type="hidden" name="catalogItemNames" value="{item.itemName}">
                        <input type="hidden" name="catalogItemPrices" value="{item.unitPrice}">
                      </td>
                    </tr>
                  {/for}
                {/if}
                </tbody>
              </table>

              <!-- Formular zum Hinzufügen -->
              <div class="row g-3 align-items-end mb-3">
                <div class="col">
                  <label for="catalogItemSelect" class="form-label">Katalogartikel wählen</label>
                  <select class="form-select" id="catalogItemSelect">
                    <option value="">-- Artikel auswählen --</option>
                    {#for item in catalogItems}
                      <option value="{item.id}" data-name="{item.name}" data-price="{item.unitPrice}">
                        {item.name} – {item.unitPrice} CHF
                      </option>
                    {/for}
                  </select>
                </div>
                <div class="col-auto">
                  <label for="itemQuantity" class="form-label">Menge</label>
                  <input type="number" class="form-control" id="itemQuantity"
                         min="1" value="1">
                </div>
                <div class="col-auto">
                  <button type="button" class="btn btn-primary" onclick="addCatalogItem()">
                    <i class="bi bi-plus-circle me-1"></i>Artikel hinzufügen
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- JavaScript‐Helpers -->
          <script>
            // Hidden‐Inputs aktualisieren
            function updateHiddenInput(checkbox) {
              const name = checkbox.getAttribute('name');
              const hiddenInput = document.querySelector('input[type="hidden"][name="' + name + '"]');
              if (hiddenInput) {
                hiddenInput.value = checkbox.checked ? "true" : "false";
              }
            }
            document.addEventListener('DOMContentLoaded', function() {
              document.querySelectorAll('input[type="checkbox"]').forEach(cb => updateHiddenInput(cb));
            });

            // Notiz‐Blöcke hinzufügen/entfernen
            function addNoteBlock() {
              const container = document.getElementById('notesContainer');
              const block = document.createElement('div');
              block.className = 'note-block mb-3 border rounded p-2';
              block.innerHTML = `
                <input type="hidden" name="notes[][id]" value="" />
                <div class="mb-2">
                  <label class="form-label">Titel</label>
                  <input type="text" class="form-control" name="notes[][title]" placeholder="Optional">
                </div>
                <div class="mb-2">
                  <label class="form-label">Kategorie</label>
                  <select class="form-select" name="notes[][category]" required>
                    <option value="" disabled selected>-- auswählen --</option>
                    {#for cat in categories}
                      <option value="{cat.name}">{cat.name}</option>
                    {/for}
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Inhalt</label>
                  <textarea class="form-control" name="notes[][content]" rows="2" required></textarea>
                </div>
                <div class="mb-2">
                  <label class="form-label">Tags (Komma‐getrennt)</label>
                  <input type="text" class="form-control" name="notes[][tags]" placeholder="z. B. dringlich,prüfung">
                </div>
                <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeNoteBlock(this)">
                  Entfernen
                </button>
              `;
              container.appendChild(block);
            }
            function removeNoteBlock(btn) {
              btn.closest('.note-block').remove();
            }

            // Katalogartikel‐Skript
            let catalogItemIndex = {#if entry}{entry.catalogItems.size()}{#else}0{/if};
            function addCatalogItem() {
              const select = document.getElementById('catalogItemSelect');
              const quantity = document.getElementById('itemQuantity');
              const option = select.options[select.selectedIndex];
              if (!select.value) { alert('Bitte einen Katalogartikel auswählen'); return; }
              const itemId = parseInt(select.value);
              const itemName = option.dataset.name;
              const unitPrice = parseFloat(option.dataset.price);
              const itemQuantity = parseInt(quantity.value);
              const totalPrice = unitPrice * itemQuantity;
              const tbody = document.querySelector('#catalogItemsTable tbody');
              const row = document.createElement('tr');
              const cells = [
                createCell(itemName),
                createCell(itemQuantity),
                createCell(unitPrice + ' CHF'),
                createCell(totalPrice + ' CHF'),
                createActionCell(itemId, itemName, itemQuantity, unitPrice, totalPrice)
              ];
              cells.forEach(c => row.appendChild(c));
              tbody.appendChild(row);
              catalogItemIndex++;
              select.value = '';
              quantity.value = '1';
            }
            function createCell(text) {
              const cell = document.createElement('td');
              cell.textContent = text;
              return cell;
            }
            function createActionCell(id, name, quantity, unitPrice, totalPrice) {
              const cell = document.createElement('td');
              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.className = 'btn btn-danger btn-sm';
              removeBtn.textContent = 'Entfernen';
              removeBtn.onclick = function() { removeCatalogItem(this); };
              cell.appendChild(removeBtn);

              // Versteckte Inputs für Katalogartikel‐Daten
              [
                { name: 'catalogItemIds', value: id },
                { name: 'catalogItemQuantities', value: quantity },
                { name: 'catalogItemNames', value: name },
                { name: 'catalogItemPrices', value: unitPrice }
              ].forEach(inp => {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = inp.name;
                hidden.value = inp.value;
                cell.appendChild(hidden);
              });
              return cell;
            }
            function removeCatalogItem(button) {
              button.closest('tr').remove();
            }

            // Wartezeit‐Eingabe ent/dissable
            document.addEventListener('DOMContentLoaded', function() {
              const wt = document.getElementById('hasWaitingTime');
              if (wt) {
                wt.addEventListener('change', function() {
                  const inp = document.getElementById('waitingTimeMinutes');
                  inp.disabled = !this.checked;
                  if (!this.checked) inp.value = '0';
                });
                if (!wt.checked) document.getElementById('waitingTimeMinutes').disabled = true;
              }
            });
          </script>

          <!-- Speichern/Abbrechen -->
          <div class="mt-3">
            <button type="submit" class="btn btn-primary">Speichern</button>
            <a href="/timetracking" class="btn btn-outline-secondary">Abbrechen</a>
          </div>
        </form>
      </div>
    </div>
  {/content}
{/include}
