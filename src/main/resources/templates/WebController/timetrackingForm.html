{#include layout}
  {#title}{#if entry}Edit Time Entry{#else}Log Time{/if} - Baunex{/title}
  {#header}{#if entry}Edit Time Entry{#else}Log Time{/if}{/header}
  {#content}
    <div class="card">
      <div class="card-header">{#if entry}Edit Entry{#else}New Entry{/if}</div>
      <div class="card-body">
        <form action="/timetracking/save" method="post">
          {#if entry}
            <input type="hidden" name="id" value="{entry.id}" />
          {/if}

          <!-- Hidden inputs for default values -->
          <input type="hidden" name="hasNightSurcharge" value="false">
          <input type="hidden" name="hasWeekendSurcharge" value="false">
          <input type="hidden" name="hasHolidaySurcharge" value="false">
          <input type="hidden" name="notBillable" value="false">
          <input type="hidden" name="invoiced" value="false">
          <input type="hidden" name="hasWaitingTime" value="false">

          <div class="mb-3">
            <label for="employeeId" class="form-label">Employee</label>
            <select class="form-select" id="employeeId" name="employeeId" required>
              {#for employee in employees}
                <option value="{employee.id}" {#if entry != null && entry.employeeId == employee.id}selected{/if}>
                  {employee.email}
                </option>
              {/for}
            </select>
          </div>

          <div class="mb-3">
            <label for="projectId" class="form-label">Project</label>
            <select class="form-select" id="projectId" name="projectId" required>
              {#for project in projects}
                <option value="{project.id}" {#if entry != null && entry.projectId == project.id}selected{/if}>
                  {project.name}
                </option>
              {/for}
            </select>
          </div>

          <div class="mb-3">
            <label for="date" class="form-label">Date</label>
            <input type="date" class="form-control" id="date" name="date"
                   value="{#if entry}{entry.date}{#else}{currentDate}{/if}" required />
          </div>

          <div class="mb-3">
            <label for="hoursWorked" class="form-label">Hours Worked</label>
            <input type="number" class="form-control" id="hoursWorked" name="hoursWorked" step="0.1" min="0"
                   value="{#if entry}{entry.hoursWorked}{/if}" required />
          </div>

          <div class="mb-3">
            <label for="note" class="form-label">Note</label>
            <textarea class="form-control" id="note" name="note" rows="3">{#if entry}{entry.notes}{/if}</textarea>
          </div>

          <div class="mb-3">
            <label for="hourlyRate" class="form-label">Hourly Rate</label>
            <input type="number" class="form-control" id="hourlyRate" name="hourlyRate" step="0.01"
                   value="{#if entry}{entry.hourlyRate}{/if}" />
          </div>

          <!-- Surcharges Section -->
          <div class="mb-3">
            <label class="form-label">Surcharges</label>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="hasNightSurcharge" name="hasNightSurcharge" value="true"
                     {#if entry && entry.hasNightSurcharge}checked{/if} onchange="updateHiddenInput(this)">
              <label class="form-check-label" for="hasNightSurcharge">Night Surcharge</label>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="hasWeekendSurcharge" name="hasWeekendSurcharge" value="true"
                     {#if entry && entry.hasWeekendSurcharge}checked{/if} onchange="updateHiddenInput(this)">
              <label class="form-check-label" for="hasWeekendSurcharge">Weekend Surcharge</label>
            </div>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="hasHolidaySurcharge" name="hasHolidaySurcharge" value="true"
                     {#if entry && entry.hasHolidaySurcharge}checked{/if} onchange="updateHiddenInput(this)">
              <label class="form-check-label" for="hasHolidaySurcharge">Holiday Surcharge</label>
            </div>
          </div>

          <!-- Additional Costs Section -->
          <div class="mb-3">
            <label class="form-label">Additional Costs</label>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="travelTimeMinutes" class="form-label">Travel Time (minutes)</label>
                <input type="number" class="form-control" id="travelTimeMinutes" name="travelTimeMinutes" min="0"
                       value="{#if entry}{entry.travelTimeMinutes}{/if}" />
              </div>
              <div class="col-md-6">
                <label for="disposalCost" class="form-label">Disposal Cost (CHF)</label>
                <input type="number" class="form-control" id="disposalCost" name="disposalCost" step="0.01" min="0"
                       value="{#if entry}{entry.disposalCost}{/if}" />
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="hasWaitingTime" name="hasWaitingTime" value="true"
                         {#if entry && entry.hasWaitingTime}checked{/if} onchange="updateHiddenInput(this)">
                  <label class="form-check-label" for="hasWaitingTime">Waiting Time</label>
                </div>
              </div>
              <div class="col-md-6">
                <label for="waitingTimeMinutes" class="form-label">Waiting Time (minutes)</label>
                <input type="number" class="form-control" id="waitingTimeMinutes" name="waitingTimeMinutes" min="0"
                       value="{#if entry}{entry.waitingTimeMinutes}{/if}" />
              </div>
            </div>
          </div>

          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="notBillable" name="notBillable" value="true"
                   {#if entry && !entry.billable}checked{/if} onchange="updateHiddenInput(this)">
            <label class="form-check-label" for="notBillable">Not Billable</label>
          </div>

          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="invoiced" name="invoiced" value="true"
                   {#if entry && entry.invoiced}checked{/if} onchange="updateHiddenInput(this)">
            <label class="form-check-label" for="invoiced">Invoiced</label>
          </div>

          <!-- Catalog Items Section -->
          <div class="mb-3">
            <label class="form-label">Catalog Items</label>
            <div class="catalog-items-container">
              <table class="table" id="catalogItemsTable">
                <thead>
                  <tr>
                    <th>Item Name</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {#if entry && !entry.catalogItems.isEmpty()}
                    {#for item in entry.catalogItems}
                    <tr>
                      <td>{item.itemName}</td>
                      <td>{item.quantity}</td>
                      <td>{item.unitPrice} CHF</td>
                      <td>{item.totalPrice} CHF</td>
                      <td>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeCatalogItem(this)">Remove</button>
                        <input type="hidden" name="catalogItemIds" value="{item.catalogItemId}">
                        <input type="hidden" name="catalogItemQuantities" value="{item.quantity}">
                        <input type="hidden" name="catalogItemNames" value="{item.itemName}">
                        <input type="hidden" name="catalogItemPrices" value="{item.unitPrice}">
                      </td>
                    </tr>
                    {/for}
                  {/if}
                </tbody>
              </table>
              
              <!-- Add Catalog Item Form -->
              <div class="row g-3 align-items-end mb-3">
                <div class="col">
                  <label for="catalogItemSelect" class="form-label">Catalog Item</label>
                  <select class="form-select" id="catalogItemSelect">
                    <option value="">Select a catalog item</option>
                    {#for item in catalogItems}
                    <option value="{item.id}" data-name="{item.name}" data-price="{item.unitPrice}">
                      {item.name} - {item.unitPrice} CHF
                    </option>
                    {/for}
                  </select>
                </div>
                <div class="col-auto">
                  <label for="itemQuantity" class="form-label">Quantity</label>
                  <input type="number" class="form-control" id="itemQuantity" min="1" value="1">
                </div>
                <div class="col-auto">
                  <button type="button" class="btn btn-primary" onclick="addCatalogItem()">
                    <i class="bi bi-plus-circle me-2"></i>Add Item
                  </button>
                </div>
              </div>
            </div>
          </div>

          <script>
            function updateHiddenInput(checkbox) {
              const name = checkbox.getAttribute('name');
              const hiddenInput = document.querySelector('input[type="hidden"][name="' + name + '"]');
              if (hiddenInput) {
                hiddenInput.value = checkbox.checked ? "true" : "false";
              }
            }

            // Initialize hidden inputs based on checkbox states
            document.addEventListener('DOMContentLoaded', function() {
              const checkboxes = document.querySelectorAll('input[type="checkbox"]');
              checkboxes.forEach(checkbox => {
                updateHiddenInput(checkbox);
              });
            });

            let catalogItemIndex = {#if entry}{entry.catalogItems.size()}{#else}0{/if};

            function addCatalogItem() {
              const select = document.getElementById('catalogItemSelect');
              const quantity = document.getElementById('itemQuantity');
              const option = select.options[select.selectedIndex];
              
              if (!select.value) {
                alert('Please select a catalog item');
                return;
              }

              const itemId = parseInt(select.value);
              if (isNaN(itemId)) {
                alert('Invalid catalog item ID');
                return;
              }

              const itemName = option.dataset.name;
              const unitPrice = parseFloat(option.dataset.price);
              const itemQuantity = parseInt(quantity.value);
              const totalPrice = unitPrice * itemQuantity;

              const tbody = document.querySelector('#catalogItemsTable tbody');
              const row = document.createElement('tr');
              
              // Create cells
              const cells = [
                createCell(itemName),
                createCell(itemQuantity),
                createCell(unitPrice + ' CHF'),
                createCell(totalPrice + ' CHF'),
                createActionCell(itemId, itemName, itemQuantity, unitPrice, totalPrice)
              ];
              
              cells.forEach(cell => row.appendChild(cell));
              tbody.appendChild(row);
              catalogItemIndex++;

              // Reset form
              select.value = '';
              quantity.value = '1';
            }

            function createCell(text) {
              const cell = document.createElement('td');
              cell.textContent = text;
              return cell;
            }

            function createActionCell(id, name, quantity, unitPrice, totalPrice) {
              const cell = document.createElement('td');
              
              // Create remove button
              const removeButton = document.createElement('button');
              removeButton.type = 'button';
              removeButton.className = 'btn btn-danger btn-sm';
              removeButton.textContent = 'Remove';
              removeButton.onclick = function() { removeCatalogItem(this); };
              cell.appendChild(removeButton);

              // Add hidden inputs for catalog item data
              const hiddenInputs = [
                { name: 'catalogItemIds', value: id },
                { name: 'catalogItemQuantities', value: quantity },
                { name: 'catalogItemNames', value: name },
                { name: 'catalogItemPrices', value: unitPrice }
              ];
              
              hiddenInputs.forEach(input => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = input.name;
                hiddenInput.value = input.value;
                cell.appendChild(hiddenInput);
              });

              return cell;
            }

            function removeCatalogItem(button) {
              const row = button.closest('tr');
              row.remove();
            }

            // Show/hide waiting time minutes based on checkbox
            document.getElementById('hasWaitingTime').addEventListener('change', function() {
              const waitingTimeInput = document.getElementById('waitingTimeMinutes');
              waitingTimeInput.disabled = !this.checked;
              if (!this.checked) {
                waitingTimeInput.value = '0';
              }
            });
          </script>

          <div class="mt-3">
            <button type="submit" class="btn btn-primary">Save</button>
            <a href="/timetracking" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  {/content}
{/include}
