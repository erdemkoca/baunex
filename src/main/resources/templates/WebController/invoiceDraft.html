{#include layout}
    {#title}Rechnungsentwurf{/title}
    {#header}Rechnungsentwurf{/header}
    {#content}
        <div class="container-fluid">
            <form action="/invoice-draft/save" method="post" class="needs-validation" novalidate>
                <input type="hidden" name="id" value="{invoiceDraft.id ?: ''}">
                <input type="hidden" name="projectId" value="{invoiceDraft.projectId}">
                <input type="hidden" name="customerId" value="{invoiceDraft.customerId}">

                <!-- Header Section -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Rechnungsinformationen</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="invoiceDate" class="form-label">Datum</label>
                                        <input type="date" class="form-control" id="invoiceDate" name="invoiceDate" 
                                               value="{invoiceDraft.invoiceDate}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="dueDate" class="form-label">Fälligkeitsdatum</label>
                                        <input type="date" class="form-control" id="dueDate" name="dueDate" 
                                               value="{invoiceDraft.dueDate}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="status" class="form-label">Status</label>
                                        <select class="form-select" id="status" name="status" required>
                                            <option value="DRAFT" {#if invoiceDraft.status == 'DRAFT'}selected{/if}>Entwurf</option>
                                            <option value="SENT" {#if invoiceDraft.status == 'SENT'}selected{/if}>Gesendet</option>
                                            <option value="PAID" {#if invoiceDraft.status == 'PAID'}selected{/if}>Bezahlt</option>
                                            <option value="CANCELLED" {#if invoiceDraft.status == 'CANCELLED'}selected{/if}>Storniert</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Items Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">Rechnungspositionen</h5>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-outline-primary" onclick="addTimeEntry()">
                                            <i class="bi bi-clock"></i> Zeit-Eintrag
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" onclick="addCatalogItem()">
                                            <i class="bi bi-box"></i> Katalog-Item
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" onclick="addManualItem()">
                                            <i class="bi bi-plus"></i> Manuell
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="itemsTable">
                                        <thead>
                                            <tr>
                                                <th style="width: 40px"></th>
                                                <th>Beschreibung</th>
                                                <th style="width: 100px">Menge</th>
                                                <th style="width: 120px">Einzelpreis</th>
                                                <th style="width: 100px">MwSt %</th>
                                                <th style="width: 120px">Nettobetrag</th>
                                                <th style="width: 120px">MwSt</th>
                                                <th style="width: 120px">Bruttobetrag</th>
                                                <th style="width: 60px"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="itemsTableBody">
                                            {#for item in invoiceDraft.items}
                                            <tr data-item-id="{item.id}" data-item-type="{item.type}">
                                                <td><i class="bi bi-grip-vertical handle"></i></td>
                                                <td>
                                                    <input type="text" class="form-control" name="items[{item_index}].description" 
                                                           value="{item.description}" required>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control quantity" name="items[{item_index}].quantity" 
                                                           value="{item.quantity}" step="0.01" required>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control unit-price" name="items[{item_index}].unitPrice" 
                                                           value="{item.unitPrice}" step="0.01" required>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control vat-rate" name="items[{item_index}].vatRate" 
                                                           value="{item.vatRate}" step="0.01" required>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control total-amount" name="items[{item_index}].totalAmount" 
                                                           value="{item.totalAmount}" step="0.01" readonly>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control vat-amount" name="items[{item_index}].vatAmount" 
                                                           value="{item.vatAmount}" step="0.01" readonly>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control grand-total" name="items[{item_index}].grandTotal" 
                                                           value="{item.grandTotal}" step="0.01" readonly>
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {/for}
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="5" class="text-end"><strong>Summe</strong></td>
                                                <td><input type="number" class="form-control" id="totalAmount" value="{invoiceDraft.totalAmount}" readonly></td>
                                                <td><input type="number" class="form-control" id="vatAmount" value="{invoiceDraft.vatAmount}" readonly></td>
                                                <td><input type="number" class="form-control" id="grandTotal" value="{invoiceDraft.grandTotal}" readonly></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Notizen</h5>
                                <textarea class="form-control" name="notes" rows="3">{invoiceDraft.notes ?: ''}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Speichern
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                                    <i class="bi bi-x"></i> Abbrechen
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-primary" onclick="exportPdf()">
                                    <i class="bi bi-file-pdf"></i> Als PDF exportieren
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- JavaScript -->
        <script>
            // Initialize Sortable
            new Sortable(document.getElementById('itemsTableBody'), {
                handle: '.handle',
                animation: 150,
                onEnd: function() {
                    updateItemOrder();
                }
            });

            // Calculate totals when quantity, unit price or VAT rate changes
            document.querySelectorAll('.quantity, .unit-price, .vat-rate').forEach(input => {
                input.addEventListener('input', calculateRowTotals);
            });

            function calculateRowTotals(event) {
                const row = event.target.closest('tr');
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
                const vatRate = parseFloat(row.querySelector('.vat-rate').value) || 0;

                const totalAmount = quantity * unitPrice;
                const vatAmount = totalAmount * (vatRate / 100);
                const grandTotal = totalAmount + vatAmount;

                row.querySelector('.total-amount').value = totalAmount.toFixed(2);
                row.querySelector('.vat-amount').value = vatAmount.toFixed(2);
                row.querySelector('.grand-total').value = grandTotal.toFixed(2);

                calculateTotals();
            }

            function calculateTotals() {
                let totalAmount = 0;
                let vatAmount = 0;
                let grandTotal = 0;

                document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                    totalAmount += parseFloat(row.querySelector('.total-amount').value) || 0;
                    vatAmount += parseFloat(row.querySelector('.vat-amount').value) || 0;
                    grandTotal += parseFloat(row.querySelector('.grand-total').value) || 0;
                });

                document.getElementById('totalAmount').value = totalAmount.toFixed(2);
                document.getElementById('vatAmount').value = vatAmount.toFixed(2);
                document.getElementById('grandTotal').value = grandTotal.toFixed(2);
            }

            function updateItemOrder() {
                document.querySelectorAll('#itemsTableBody tr').forEach((row, index) => {
                    row.querySelectorAll('input').forEach(input => {
                        const name = input.getAttribute('name');
                        if (name) {
                            input.setAttribute('name', name.replace(/\[\d+\]/, `[${index}]`));
                        }
                    });
                });
            }

            function addTimeEntry() {
                // TODO: Implement time entry selection
                alert('Zeit-Eintrag hinzufügen - Noch nicht implementiert');
            }

            function addCatalogItem() {
                // TODO: Implement catalog item selection
                alert('Katalog-Item hinzufügen - Noch nicht implementiert');
            }

            function addManualItem() {
                const tbody = document.getElementById('itemsTableBody');
                const index = tbody.children.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><i class="bi bi-grip-vertical handle"></i></td>
                    <td><input type="text" class="form-control" name="items[${index}].description" required></td>
                    <td><input type="number" class="form-control quantity" name="items[${index}].quantity" value="1" step="0.01" required></td>
                    <td><input type="number" class="form-control unit-price" name="items[${index}].unitPrice" value="0" step="0.01" required></td>
                    <td><input type="number" class="form-control vat-rate" name="items[${index}].vatRate" value="8.1" step="0.01" required></td>
                    <td><input type="number" class="form-control total-amount" name="items[${index}].totalAmount" value="0" step="0.01" readonly></td>
                    <td><input type="number" class="form-control vat-amount" name="items[${index}].vatAmount" value="0" step="0.01" readonly></td>
                    <td><input type="number" class="form-control grand-total" name="items[${index}].grandTotal" value="0" step="0.01" readonly></td>
                    <td>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                initializeRow(row);
            }

            function removeItem(button) {
                button.closest('tr').remove();
                updateItemOrder();
                calculateTotals();
            }

            function initializeRow(row) {
                row.querySelectorAll('.quantity, .unit-price, .vat-rate').forEach(input => {
                    input.addEventListener('input', calculateRowTotals);
                });
                calculateRowTotals({ target: row.querySelector('.quantity') });
            }

            function exportPdf() {
                // TODO: Implement PDF export
                alert('PDF Export - Noch nicht implementiert');
            }

            // Initialize existing rows
            document.querySelectorAll('#itemsTableBody tr').forEach(initializeRow);
        </script>
    {/content}
{/include} 