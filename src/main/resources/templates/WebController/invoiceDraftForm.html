<!-- invoiceDraftForm.html -->
{#include layout}
  {#title}Neuer Rechnungsentwurf{/title}
  {#header}Neuer Rechnungsentwurf{/header}
  {#content}
    <div class="container-fluid" id="invoice-app"
         data-project='{projectJson}'
         data-company='{companyJson}'
         data-billing='{billingJson}'
         data-vat-rate="{company.defaultVatRate ?: 7.7}"
         data-current-date="{currentDate}"
         data-due-date="{dueDate}">

      <!-- Vue-kompatibles Formular -->
      <form @submit.prevent="submitInvoice">
        <div class="card mb-4">
          <div class="card-body">
            <div class="mb-4">
              <label class="form-label">Projekt</label>
              <select v-model="project.id" class="form-select" disabled>
                <option :value="project.id">{{ project.name }} - {{ project.customerName }}</option>
              </select>
            </div>

            <div class="row mb-4">
              <div class="col-md-6">
                <h4>{{ company.name }}</h4>
                <p>{{ company.street }}<br>{{ company.zipCode }} {{ company.city }}<br>{{ company.country }}</p>
                <p>Tel: {{ company.phone }}<br>E-Mail: {{ company.email }}<br>Web: {{ company.website }}</p>
              </div>
              <div class="col-md-6 text-end">
                <div class="mb-3">
                  <label class="form-label">Rechnungsnummer</label>
                  <input v-model="invoiceNumber" type="text" class="form-control">
                </div>
                <div class="mb-3">
                  <label class="form-label">Rechnungsdatum</label>
                  <input v-model="invoiceDate" type="date" class="form-control">
                </div>
                <div class="mb-3">
                  <label class="form-label">FÃ¤lligkeitsdatum</label>
                  <input v-model="dueDate" type="date" class="form-control">
                </div>
              </div>
            </div>

            <h5 class="text-center">Rechnungspositionen</h5>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Bezeichnung</th>
                  <th>Typ</th>
                  <th>Menge</th>
                  <th>Preis</th>
                  <th>Betrag</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(item, index) in items" :key="index">
                  <td><input v-model="item.description" class="form-control"></td>
                  <td>
                    <select v-model="item.type" class="form-select">
                      <option value="VA">VA</option>
                      <option value="IC">IC</option>
                    </select>
                  </td>
                  <td><input v-model.number="item.quantity" type="number" class="form-control"></td>
                  <td><input v-model.number="item.price" type="number" class="form-control"></td>
                  <td>{{ (item.quantity * item.price).toFixed(2) }}</td>
                  <td><button @click.prevent="removeItem(index)" class="btn btn-sm btn-outline-danger">x</button></td>
                </tr>
              </tbody>
            </table>
            <button @click.prevent="addItem" class="btn btn-outline-primary">+ Position</button>

            <div class="mt-4">
              <h5>Zusammenfassung</h5>
              <p>Brutto: {{ grossTotal.toFixed(2) }} CHF</p>
              <p>MWST ({{ vatRate }}%): {{ vatAmount.toFixed(2) }} CHF</p>
              <p><strong>Nettobetrag: {{ netTotal.toFixed(2) }} CHF</strong></p>
            </div>

            <div class="mt-3">
              <label class="form-label">Notizen</label>
              <textarea v-model="notes" class="form-control"></textarea>
            </div>

            <div class="mt-4 d-flex gap-2">
              <button type="submit" class="btn btn-primary">Rechnungsentwurf speichern</button>
              <a href="/invoice-drafts" class="btn btn-outline-secondary">Abbrechen</a>
            </div>

          </div>
        </div>
      </form>

      <script type="module">
        const { createApp } = Vue
        const app = document.getElementById('invoice-app');
        const project = JSON.parse(app.dataset.project || 'null');
        const company = JSON.parse(app.dataset.company || 'null');
        const billing = JSON.parse(app.dataset.billing || 'null');
        const vatRate = parseFloat(app.dataset.vatRate || '7.7');
        const currentDate = app.dataset.currentDate;
        const dueDate = app.dataset.dueDate;

        createApp({
          data() {
            return {
              company,
              project,
              vatRate,
              invoiceNumber: '',
              invoiceDate: currentDate,
              dueDate: dueDate,
              notes: '',
              items: [
                ...(project?.timeEntries || []).map(e => ({
                  description: e.notes,
                  type: 'VA',
                  quantity: e.hoursWorked,
                  price: e.hourlyRate
                })),
                ...(project?.catalogItems || []).map(e => ({
                  description: e.itemName,
                  type: 'IC',
                  quantity: e.quantity,
                  price: e.unitPrice
                }))
              ]
            };
          },
          computed: {
            grossTotal() {
              return this.items.reduce((sum, i) => sum + i.quantity * i.price, 0);
            },
            vatAmount() {
              return this.grossTotal * (this.vatRate / 100);
            },
            netTotal() {
              return this.grossTotal + this.vatAmount;
            }
          },
          methods: {
            addItem() {
              this.items.push({ description: '', type: 'VA', quantity: 1, price: 0 });
            },
            removeItem(index) {
              this.items.splice(index, 1);
            },
            submitInvoice() {
              alert('Rechnungsdaten bereit zum Senden');
              console.log({
                projectId: this.project.id,
                invoiceNumber: this.invoiceNumber,
                invoiceDate: this.invoiceDate,
                dueDate: this.dueDate,
                notes: this.notes,
                items: this.items
              });
            }
          }
        }).mount('#invoice-app');
      </script>

      <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    </div>
  {/content}
{/include}
