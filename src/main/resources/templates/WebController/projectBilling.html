<div class="card">
    <div class="card-body">
        <!-- Zeiterfassungen -->
        <h5 class="mb-4">Zeiterfassungen</h5>
        {#if billing.timeEntries.isEmpty()}
            <p class="text-muted">Keine Zeiterfassungen vorhanden.</p>
        {#else}
            <div class="accordion" id="billingTimeEntriesAccordion">
                {#for e in billing.timeEntries}
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button
                                    class="accordion-button collapsed"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#billingEntry{e.id}"
                                    aria-expanded="false"
                                    aria-controls="billingEntry{e.id}"
                            >
                                <div class="d-flex justify-content-between w-100 me-3">
                                    <div>
                                        <strong>{e.employeeEmail}</strong> – {e.date}
                                    </div>
                                    <div>
                <span class="badge bg-primary me-2">
                  {e.hoursWorked} Stunden
                </span>
                                        {#if !e.billable}
                                            <span class="badge bg-secondary">Nicht verrechenbar</span>
                                        {/if}
                                        <span class="badge bg-success ms-2">
                  {#if e.costBreakdown != null}
                      {e.costBreakdown.totalServiceCost} CHF
                  {#else}
                      {e.cost} CHF
                  {/if}
                </span>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div
                                id="billingEntry{e.id}"
                                class="accordion-collapse collapse"
                                data-bs-parent="#billingTimeEntriesAccordion"
                        >
                            <div class="accordion-body">
                                <!-- Grundinformationen -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6>Grundinformationen</h6>
                                        <p><strong>Notiz:</strong> {e.notes ?: "—"}</p>
                                        <p><strong>Stundensatz:</strong> {e.hourlyRate ?: "—"} CHF</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Status</h6>
                                        <p>
                  <span class="badge {#if e.invoiced}bg-success{#else}bg-warning{/if}">
                    {#if e.invoiced}Fakturiert{#else}Nicht fakturiert{/if}
                  </span>
                                        </p>
                                    </div>
                                </div>

                                <!-- Kostenaufschlüsselung -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6>Kostenaufschlüsselung</h6>
                                        <table class="table table-sm">
                                            <tbody>
                                            <!-- Zeitkosten -->
                                            <tr>
                                                <td>Zeitkosten</td>
                                                <td class="text-end">{e.costBreakdown.timeCost} CHF</td>
                                            </tr>

                                            <!-- Zuschläge -->
                                            {#if e.costBreakdown.nightSurcharge != null}
                                                <tr>
                                                    <td>Nachtzuschlag</td>
                                                    <td class="text-end">{e.costBreakdown.nightSurcharge} CHF</td>
                                                </tr>
                                            {/if}
                                            {#if e.costBreakdown.weekendSurcharge != null}
                                                <tr>
                                                    <td>Wochenendzuschlag</td>
                                                    <td class="text-end">{e.costBreakdown.weekendSurcharge} CHF</td>
                                                </tr>
                                            {/if}
                                            {#if e.costBreakdown.holidaySurcharge != null}
                                                <tr>
                                                    <td>Feiertagszuschlag</td>
                                                    <td class="text-end">{e.costBreakdown.holidaySurcharge} CHF</td>
                                                </tr>
                                            {/if}

                                            <!-- Zusätzliche Kosten -->
                                            {#if e.costBreakdown.travelTimeCost != null}
                                                <tr>
                                                    <td>Reisezeit ({e.travelTimeMinutes} min)</td>
                                                    <td class="text-end">{e.costBreakdown.travelTimeCost} CHF</td>
                                                </tr>
                                            {/if}
                                            {#if e.costBreakdown.waitingTimeCost != null}
                                                <tr>
                                                    <td>Wartezeit ({e.waitingTimeMinutes} min)</td>
                                                    <td class="text-end">{e.costBreakdown.waitingTimeCost} CHF</td>
                                                </tr>
                                            {/if}
                                            {#if e.costBreakdown.disposalCost != null}
                                                <tr>
                                                    <td>Entsorgungskosten</td>
                                                    <td class="text-end">{e.costBreakdown.disposalCost} CHF</td>
                                                </tr>
                                            {/if}

                                            <!-- Gesamtkosten Dienstleistung -->
                                            <tr class="table-primary">
                                                <td><strong>Gesamtkosten Dienstleistung</strong></td>
                                                <td class="text-end">
                                                    <strong>{e.costBreakdown.totalServiceCost} CHF</strong>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {/for}
            </div>

            <!-- Zusammenfassung -->
            <div class="alert alert-info mt-3">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Anzahl Zeiterfassungen:</strong> {billing.timeEntries.size}
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Gesamtkosten Dienstleistung:</strong> {billing.timeTotal} CHF
                    </div>
                </div>
            </div>
        {/if}

        <!-- Alle Katalogartikel -->
        <h5 class="mt-5 mb-4">Alle Katalogartikel</h5>
        {#if billing.materials.isEmpty() && billing.timeEntries.isEmpty()}
            <p class="text-muted">Keine Katalogartikel vorhanden.</p>
        {#else}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Quelle</th>
                        <th>Artikel</th>
                        <th>Menge</th>
                        <th>Einzelpreis</th>
                        <th>Gesamt</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Projekt-Katalogartikel -->
                    {#for m in billing.materials}
                        <tr>
                            <td>Projekt</td>
                            <td>{m.itemName}</td>
                            <td>{m.quantity}</td>
                            <td>{m.unitPrice} CHF</td>
                            <td>{m.totalPrice} CHF</td>
                        </tr>
                    {/for}

                    {! Zeiterfassungs-Katalogartikel !}
                    {#for entry in billing.timeEntries}
                        {#for item in entry.catalogItems}
                            <tr>
                                <td>Zeiterfassung ({entry.date})</td>
                                <td>{item.itemName}</td>
                                <td>{item.quantity}</td>
                                <td>{item.unitPrice} CHF</td>
                                <td>{item.totalPrice} CHF</td>
                            </tr>
                        {/for}
                    {/for}
                    </tbody>
                    <tfoot>
                    <tr class="table-primary">
                        <td colspan="4"><strong>Gesamt Katalogartikel</strong></td>
                        <td class="text-end">
                            <strong>{billing.costBreakdown.totalCatalogItemsAndMaterials} CHF</strong>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        {/if}

        <!-- Gesamtsumme -->
        <div class="mt-5">
            <div class="alert alert-success">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Gesamtkosten Dienstleistung:</strong> {billing.timeTotal} CHF
                    </div>
                    <div class="col-md-6">
                        <strong>Gesamtkosten Katalogartikel:</strong> {billing.costBreakdown.totalCatalogItemsAndMaterials} CHF
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <h4 class="mb-0"><strong>Gesamtsumme:</strong> {billing.total} CHF</h4>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
