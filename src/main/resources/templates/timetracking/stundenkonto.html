{#include layout}
  {#title}Stundenkonto – Baunex{/title}
  {#header}Stundenkonto{/header}
  {#content}
    <link rel="stylesheet" href="/css/stundenkonto/styles.css">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Stundenkonto</h4>
            <div class="d-flex gap-3">
              <div class="employee-selector">
                <select id="employee-select" class="form-select">
                  <option value="">Mitarbeiter auswählen...</option>
                  {#for employee in employees}
                    <option value="{employee.id}" {#if employee.id == selectedEmployeeId}selected{/if}>
                      {employee.firstName} {employee.lastName}
                    </option>
                  {/for}
                </select>
              </div>
              <div>
                <select id="year-select" class="form-select">
                  {#for year in years}
                    <option value="{year}" {#if year == currentYear}selected{/if}>
                      {year}
                    </option>
                  {/for}
                </select>
              </div>
            </div>
          </div>
          
          {#if monthlyAccount}
            <!-- Summary Section -->
            <div class="summary-section">
              <div class="row">
                <!-- Urlaubstage Box -->
                <div class="col-md-6 mb-4">
                  <div class="summary-card">
                    <h5 class="summary-card-title">Urlaubstage</h5>
                    <div class="summary-card-content">
                      {#if vacationStats}
                        {vacationStats.usedVacationDays} von {vacationStats.totalVacationDays}, Rest {vacationStats.remainingVacationDays}
                      {#else}
                        Keine Daten verfügbar
                      {/if}
                    </div>
                  </div>
                </div>
                
                <!-- Stundenkonto Box -->
                <div class="col-md-6 mb-4">
                  <div class="summary-card">
                    <h5 class="summary-card-title">Stundenkonto</h5>
                    <div class="summary-card-content">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="hours-info">
                          {monthlyAccount.cumulativeWorkedHoursFormatted} h von {monthlyAccount.cumulativeExpectedHoursFormatted} h Soll-Stunden
                        </div>
                        <div class="balance-indicator {#if monthlyAccount.cumulativeBalance >= 0}positive{#else}negative{/if}">
                          {monthlyAccount.cumulativeBalanceFormatted} h
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Monthly Overview -->
            <div class="monthly-overview">
              <!-- Debug: Number of months: {monthlyAccount.monthlyData.size} -->
              <!-- Debug: Employee start date: {monthlyAccount.startDate} -->
              <!-- Debug: Current year: {currentYear} -->
              <!-- Debug: Employee ID: {monthlyAccount.employeeId} -->
              {#for monthData in monthlyAccount.monthlyData}
                <!-- Debug: Month {monthData.month} - {monthData.monthName} - Weeks: {monthData.weeks.size} -->
                <div class="month-section">
                  <div class="month-header">
                    <h5 class="month-name">{monthData.monthName} {currentYear}</h5>
                    <div class="month-balance-box {#if monthData.monthTotal > 0}positive{#else if monthData.monthTotal < 0}negative{#else}neutral{/if}">
                      {monthData.monthTotalFormatted} h
                    </div>
                  </div>
                  
                  <!-- Column headers - only once per month -->
                  <div class="header-container">
                    <div class="week-grid header-row">
                      <div class="day-header week-number">KW</div>
                      <div class="day-header">Mo</div>
                      <div class="day-header">Di</div>
                      <div class="day-header">Mi</div>
                      <div class="day-header">Do</div>
                      <div class="day-header">Fr</div>
                      <div class="day-header">Sa</div>
                      <div class="day-header">So</div>
                    </div>
                    <div class="total-header-box">Summe</div>
                  </div>
                  
                  {#for weekData in monthData.weeks}
                    <div class="week-container">
                      <div class="week-grid">
                        <div class="week-number">{weekData.weekNumber}</div>
                        {#for dayData in weekData.days}
                          <div class="day-cell {#if dayData.isEmpty}empty-outside-month{#else if dayData.isFuture}future-day{#else if dayData.saldo == 0 && dayData.workedHours == 0}empty{/if}">
                            <div class="date">{dayData.dateDay}</div>
                            {#if !dayData.isEmpty && !dayData.isFuture && dayData.saldo != 0}
                              <div class="delta {#if dayData.saldo > 0}positive{#else if dayData.saldo < 0}negative{#else}neutral{/if}">
                                {dayData.saldoFormatted} h
                              </div>
                            {/if}
                            {#if !dayData.isEmpty && !dayData.isFuture && dayData.isHoliday && dayData.holidayApproved}
                              <div class="holiday-label">
                                {#if dayData.holidayType == "PAID_VACATION"}Urlaub{#else}{dayData.holidayType}{/if}
                              </div>
                            {/if}
                            {#if !dayData.isEmpty && !dayData.isFuture && dayData.isPublicHoliday}
                              <div class="holiday-label public-holiday">
                                {dayData.publicHolidayName ?: "Feiertag"}
                              </div>
                            {/if}
                          </div>
                        {/for}
                      </div>
                      <div class="week-total-box {#if weekData.weekTotal > 0}positive{#else if weekData.weekTotal < 0}negative{#else}neutral{/if}">
                        {weekData.weekTotalFormatted} h
                      </div>
                    </div>
                  {/for}
                </div>
              {/for}
            </div>
          {#else}
            <div class="text-center py-5">
              <p class="text-muted">Bitte wählen Sie einen Mitarbeiter aus, um das Stundenkonto anzuzeigen.</p>
            </div>
          {/if}
        </div>
      </div>
    </div>
    
    <script src="/js/stundenkonto/app.js"></script>
  {/content}
{/include} 