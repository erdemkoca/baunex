{#include layout}
  {#title}Urlaub & Abwesenheiten – Baunex{/title}
  {#header}Urlaub & Abwesenheiten{/header}
  {#content}
    <link rel="stylesheet" href="/css/timetracking/absences.css">
    
    <div id="absences-app"
         data-holidays='{holidaysJson}'
         data-employees='{employeesJson}'
         data-pending-holidays='{pendingHolidaysJson}'
         data-approved-holidays='{approvedHolidaysJson}'
         data-rejected-holidays='{rejectedHolidaysJson}'
         data-employee-stats='{employeeStatsJson}'
         data-public-holidays='{publicHolidaysJson}'
         data-current-year='{currentYear}'>

      <!-- Pending Requests Banner (shown only when there are pending requests) -->
      <div id="pending-requests-banner" class="pending-banner" style="display: none;">
        <div class="banner-content">
          <div class="banner-icon">
            <i class="bi bi-exclamation-triangle-fill"></i>
          </div>
          <div class="banner-text">
            <strong>Urlaubsanträge zur Überprüfung</strong>
            <span id="pending-count-text">Sie haben <span id="pending-count">0</span> offene Urlaubsanträge, die überprüft werden müssen.</span>
          </div>
          <div class="banner-actions">
            <button type="button" class="btn btn-primary btn-sm" id="review-now-btn">
              <i class="bi bi-eye"></i> Jetzt überprüfen
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="dismiss-banner-btn">
              <i class="bi bi-x"></i> Später
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content Container -->
      <div class="main-content">
        <!-- Calendar Section (always shown first) -->
        <div class="calendar-section">
          <div class="section-header">
            <h2><i class="bi bi-calendar3"></i> Urlaubskalender</h2>
          </div>
          
          <div class="calendar-navigation">
            <div class="month-navigation">
              <button class="btn btn-outline-primary" onclick="previousMonth()">
                <i class="bi bi-chevron-left"></i>
              </button>
              <div class="current-month">
                <span id="current-month-display"></span>
              </div>
              <button class="btn btn-outline-primary" onclick="nextMonth()">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
            
            <div class="month-chips" id="month-chips"></div>
          </div>

          <div class="employee-legend">
            <div class="legend-container">
              <h4>Mitarbeiter</h4>
              <div class="legend-items" id="legend-items"></div>
            </div>
          </div>

          <div class="calendar-grid">
            <div class="calendar-header">
              <div class="calendar-day-header">Mo</div>
              <div class="calendar-day-header">Di</div>
              <div class="calendar-day-header">Mi</div>
              <div class="calendar-day-header">Do</div>
              <div class="calendar-day-header">Fr</div>
              <div class="calendar-day-header">Sa</div>
              <div class="calendar-day-header">So</div>
            </div>
            <div class="calendar-body" id="calendar-body"></div>
          </div>
        </div>

        <!-- Holiday Requests Section (shown only when there are requests) -->
        <div id="holiday-requests-section" class="holiday-requests-section" style="display: none;">
          <div class="section-header">
            <h2><i class="bi bi-clipboard-check"></i> Urlaubsanträge</h2>
          </div>
          
          <div class="sticky-tabs">
            <ul class="nav nav-tabs" id="request-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-content" type="button" role="tab">
                  Offen <span class="badge bg-warning" id="pending-count-badge">0</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved-content" type="button" role="tab">
                  Genehmigt <span class="badge bg-success" id="approved-count-badge">0</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected-content" type="button" role="tab">
                  Abgelehnt <span class="badge bg-danger" id="rejected-count-badge">0</span>
                </button>
              </li>
            </ul>
          </div>
          
          <div class="tab-content" id="request-tab-content">
            <div class="tab-pane fade show active" id="pending-content" role="tabpanel">
              <div id="pending-requests"></div>
              <div id="no-pending" class="text-center py-4" style="display: none;">
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Keine offenen Urlaubsanträge</h4>
                <p class="text-muted">Alle Urlaubsanträge wurden bearbeitet.</p>
              </div>
            </div>
            
            <div class="tab-pane fade" id="approved-content" role="tabpanel">
              <div id="approved-requests"></div>
              <div id="no-approved" class="text-center py-4" style="display: none;">
                <i class="bi bi-calendar-check text-muted" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Keine genehmigten Urlaubsanträge</h4>
                <p class="text-muted">Noch keine Urlaubsanträge genehmigt.</p>
              </div>
            </div>
            
            <div class="tab-pane fade" id="rejected-content" role="tabpanel">
              <div id="rejected-requests"></div>
              <div id="no-rejected" class="text-center py-4" style="display: none;">
                <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Keine abgelehnten Urlaubsanträge</h4>
                <p class="text-muted">Noch keine Urlaubsanträge abgelehnt.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Employee Accounts Section (moved to bottom) -->
        <div class="employee-accounts-section">
          <div class="section-header">
            <h2><i class="bi bi-people"></i> Mitarbeiter Urlaubskonten</h2>
          </div>
          
          <div class="search-filter">
            <div class="row">
              <div class="col-md-6">
                <input type="text" class="form-control" id="employee-search" placeholder="Mitarbeiter suchen...">
              </div>
              <div class="col-md-6 text-end">
                <button class="btn btn-outline-primary btn-sm" onclick="sortByRemaining()">
                  <i class="bi bi-sort-numeric-down"></i> Nach verbleibenden Tagen sortieren
                </button>
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table employee-table">
              <thead>
                <tr>
                  <th>Mitarbeiter</th>
                  <th>Urlaubstage genommen</th>
                  <th>Verbleibende Tage</th>
                  <th>Fortschritt</th>
                </tr>
              </thead>
              <tbody id="employee-accounts-body">
                <!-- Employee accounts will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Abwesenheit Modal -->
    <div class="modal fade" id="absenceModal" tabindex="-1" aria-labelledby="absenceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="absenceModalLabel">Neue Abwesenheit erfassen</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="absenceForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="absence-employee" class="form-label">Mitarbeiter</label>
                    <select id="absence-employee" name="employee" class="form-select" required>
                      <option value="">-- Bitte wählen --</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="absence-type" class="form-label">Abwesenheitstyp</label>
                    <select id="absence-type" name="type" class="form-select" required>
                      <option value="">-- Bitte wählen --</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="absence-start-date" class="form-label">Startdatum</label>
                    <input id="absence-start-date" name="startDate" type="date" class="form-control" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="absence-end-date" class="form-label">Enddatum</label>
                    <input id="absence-end-date" name="endDate" type="date" class="form-control" required>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="absence-reason" class="form-label">Grund (optional)</label>
                <textarea id="absence-reason" name="reason" class="form-control" rows="3" placeholder="Grund für die Abwesenheit..."></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
            <button type="button" class="btn btn-primary" id="save-absence-btn">
              <i class="bi bi-check"></i> Abwesenheit speichern
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Konflikt Modal -->
    <div class="modal fade" id="conflictModal" tabindex="-1" aria-labelledby="conflictModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="conflictModalLabel">
              <i class="bi bi-exclamation-triangle text-warning"></i> 
              Konflikt mit bestehenden Abwesenheiten
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="conflict-error-message" class="alert alert-danger d-none"></div>
            <div class="alert alert-warning">
              <i class="bi bi-info-circle"></i>
              <strong>Für diesen Zeitraum sind bereits andere Abwesenheiten hinterlegt worden.</strong>
              <br>
              Sie können diese beim Anlegen jedoch überschreiben lassen. Die vorhandenen Abwesenheiten werden dann passend gekürzt oder komplett entfernt, falls notwendig.
            </div>
            
            <h6>Folgende Abwesenheiten sind betroffen:</h6>
            <div id="conflicting-holidays-list" class="mb-3">
              <!-- Conflicting holidays will be populated here -->
            </div>
            
            <div class="alert alert-info">
              <i class="bi bi-lightbulb"></i>
              <strong>Hinweis:</strong> Wenn Sie fortfahren, werden die bestehenden Abwesenheiten automatisch angepasst oder entfernt.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
            <button type="button" class="btn btn-warning" id="override-conflict-btn">
              <i class="bi bi-check"></i> Ja, die neue Abwesenheit anlegen und die vorhandenen Abwesenheiten anpassen
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Add Button -->
    <button class="add-absence-btn" onclick="openAbsenceModal()" 
            data-bs-toggle="tooltip" 
            data-bs-placement="left" 
            data-bs-title="Einen neuen Urlaub/Abwesenheit hinzufügen">
      <i class="bi bi-plus"></i>
    </button>

    <script src="/js/timetracking/absences.js?v=8"></script>
  {/content}
{/include} 